<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Totalkmon - The Complete Experience</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-deep: #050a14;
            --bg-accent: #0b1e3b;
            --gold-glow: #ffbf00;
            --gold-muted: #c5a059;
            --text-main: #f0f0f0;
            --card-glass: rgba(20, 20, 30, 0.7);
            --red: #FF4757;
            --blue: #2ED573;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif;
            background: radial-gradient(circle at top center, var(--bg-accent), var(--bg-deep));
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            position: relative;
        }

        /* --- PARTÍCULAS (CORREGIDO) --- */
        .particles { 
            position: fixed; /* Fixed para que cubra toda la pantalla siempre */
            top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; 
            z-index: 0; /* Capa base */
        }
        .particle { 
            position: absolute; 
            background: var(--gold-glow); 
            border-radius: 50%; 
            opacity: 0.4; 
            box-shadow: 0 0 10px var(--gold-glow); /* Brillo extra */
            animation: float 15s infinite linear; 
        }
        @keyframes float { 
            0% { transform: translateY(110vh) translateX(0); opacity: 0; } 
            20% { opacity: 0.6; } 
            80% { opacity: 0.6; }
            100% { transform: translateY(-10vh) translateX(20px); opacity: 0; } 
        }

        /* --- CONTENIDO PRINCIPAL (ENCIMA DE PARTÍCULAS) --- */
        header, .tabs, .main-stage, .footer-action { z-index: 10; position: relative; }

        /* --- HEADER & LOGO --- */
        header { margin-top: 30px; text-align: center; margin-bottom: 20px; }
        .logo-container { width: 70px; height: 70px; margin: 0 auto 10px; filter: drop-shadow(0 0 15px rgba(255, 191, 0, 0.3)); transition: transform 0.5s ease; }
        .logo-container:hover { transform: scale(1.1) rotate(5deg); }
        h1 { font-family: 'Cinzel', serif; font-size: 2.5rem; letter-spacing: 3px; background: linear-gradient(to bottom, #fff, var(--gold-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tagline { font-size: 0.8rem; letter-spacing: 2px; color: var(--gold-muted); text-transform: uppercase; }

        /* --- NAVEGACIÓN (TABS SUPERIORES) --- */
        .tabs { display: flex; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 50px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .tab { padding: 10px 25px; border-radius: 40px; cursor: pointer; opacity: 0.6; transition: 0.3s; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .tab:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .tab.active { background: var(--gold-glow); color: var(--bg-deep); opacity: 1; font-weight: 800; box-shadow: 0 0 15px rgba(255, 191, 0, 0.3); }

        /* --- STAGE PRINCIPAL --- */
        .main-stage { width: 100%; max-width: 550px; padding: 20px; flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; min-height: 450px; }

        /* === SECCIÓN ORÁCULO === */
        #oracle-section { display: flex; flex-direction: column; align-items: center; width: 100%; }
        
        /* Tarjeta */
        .card { 
            width: 100%;
            background: var(--card-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 191, 0, 0.2); border-radius: 30px; padding: 50px 30px;
            text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); cursor: pointer; position: relative;
            margin-bottom: 30px;
            min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .card:hover { transform: translateY(-5px); border-color: rgba(255, 191, 0, 0.5); box-shadow: 0 30px 60px -12px rgba(255, 191, 0, 0.2); }
        .category-pill { display: inline-block; padding: 6px 15px; border-radius: 50px; background: rgba(255, 191, 0, 0.1); color: var(--gold-glow); border: 1px solid var(--gold-glow); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; }
        .question-content { font-size: 1.6rem; font-weight: 400; line-height: 1.4; }
        .hint { margin-top: 30px; font-size: 0.75rem; opacity: 0.4; text-transform: uppercase; letter-spacing: 1px; }

        /* Botonera de Categorías (RECUPERADA) */
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; }
        .btn-mode { 
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7);
            padding: 10px 20px; border-radius: 12px; cursor: pointer; font-family: 'Montserrat', sans-serif;
            font-weight: 600; font-size: 0.8rem; transition: 0.3s; text-transform: uppercase;
        }
        .btn-mode:hover, .btn-mode.active { background: var(--gold-glow); color: var(--bg-deep); border-color: var(--gold-glow); box-shadow: 0 0 15px rgba(255, 191, 0, 0.3); }

        /* === SECCIÓN DILEMA === */
        #clash-section { display: none; width: 100%; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .vs-header { text-align: center; margin-bottom: 30px; }
        .vs-title { font-family: 'Cinzel', serif; color: var(--gold-glow); font-size: 1.2rem; }
        .vs-subtitle { font-size: 0.8rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 2px; }

        .clash-card { display: flex; flex-direction: column; gap: 15px; }
        .option-btn { 
            position: relative; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            padding: 25px; border-radius: 15px; cursor: pointer; font-size: 1.1rem; font-weight: 600;
            overflow: hidden; transition: 0.3s; min-height: 80px; display: flex; align-items: center; justify-content: space-between;
        }
        .option-btn:hover { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); }
        .progress-bar { position: absolute; top: 0; left: 0; height: 100%; opacity: 0.15; width: 0%; transition: width 1s ease-out; z-index: 0; }
        .opt-text { position: relative; z-index: 2; text-align: left; width: 80%; }
        .opt-percent { position: relative; z-index: 2; font-weight: 800; font-size: 1.2rem; opacity: 0; transition: 0.3s; }
        .opt-a .progress-bar { background: var(--red); }
        .opt-b .progress-bar { background: var(--blue); }
        .voted .opt-percent { opacity: 1; }
        .voted .option-btn { cursor: default; }

        /* === MODAL DE SUGERENCIAS === */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; 
            display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; 
        }
        .modal-content { 
            background: var(--bg-accent); border: 1px solid var(--gold-muted); padding: 40px; 
            border-radius: 20px; max-width: 400px; width: 90%; text-align: center; position: relative; 
            box-shadow: 0 0 50px rgba(255, 191, 0, 0.2); 
        }
        .close-modal { position: absolute; top: 15px; right: 20px; color: #fff; cursor: pointer; font-size: 1.5rem; }
        .btn-submit { display: inline-block; margin-top: 20px; background: var(--gold-glow); color: var(--bg-deep); padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-submit:hover { transform: scale(1.05); }

        /* FOOTER */
        .footer-action { margin-bottom: 20px; text-align: center; }
        .link-suggest { color: var(--gold-muted); font-size: 0.8rem; text-decoration: none; border-bottom: 1px dotted var(--gold-muted); cursor: pointer; opacity: 0.7; }
        .link-suggest:hover { opacity: 1; color: #fff; }

    </style>
</head>
<body>

    <div class="particles" id="particles"></div>

    <header>
        <div class="logo-container">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 95C74.8528 95 95 74.8528 95 50C95 25.1472 74.8528 5 50 5C25.1472 5 5 25.1472 5 50C5 74.8528 25.1472 95 50 95Z" stroke="#FFBF00" stroke-width="2"/>
                <path d="M50 85C69.33 85 85 69.33 85 50C85 30.67 69.33 15 50 15C30.67 15 15 30.67 15 50C15 69.33 30.67 85 50 85Z" fill="#FFBF00" fill-opacity="0.1"/>
                <path d="M20 50C20 50 33 25 50 25C67 25 80 50 80 50C80 50 67 75 50 75C33 75 20 50 20 50Z" stroke="#FFBF00" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="50" cy="50" r="9" fill="#FFBF00"/>
            </svg>
        </div>
        <h1>Totalkmon</h1>
        <p class="tagline">El Oráculo de la Conversación</p>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('oracle', this)">Oráculo</div>
        <div class="tab" onclick="switchTab('clash', this)">Dilema Diario</div>
    </div>

    <div class="main-stage">
        
        <div id="oracle-section">
            <div class="card" onclick="nextQuestion()">
                <span class="category-pill" id="q-cat">Bienvenida</span>
                <p class="question-content" id="q-text">Invocando temas...</p>
                <p class="hint">Toca la carta para nueva pregunta</p>
            </div>

            <div class="controls">
                <button class="btn-mode active" onclick="setCategory('aleatorio', event)">Aleatorio</button>
                <button class="btn-mode" onclick="setCategory('Cita', event)">Cita</button>
                <button class="btn-mode" onclick="setCategory('Fiesta', event)">Fiesta</button>
                <button class="btn-mode" onclick="setCategory('Profundo', event)">Profundo</button>
            </div>
        </div>

        <div id="clash-section">
            <div class="vs-header">
                <div class="vs-title">¿De qué lado estás?</div>
                <div class="vs-subtitle">Estadísticas en tiempo real</div>
            </div>
            
            <div class="clash-card" id="clash-container">
                <div class="option-btn opt-a" onclick="vote('a')">
                    <div class="progress-bar" id="bar-a"></div>
                    <span class="opt-text" id="text-a">Cargando...</span>
                    <span class="opt-percent" id="perc-a">0%</span>
                </div>
                <div class="option-btn opt-b" onclick="vote('b')">
                    <div class="progress-bar" id="bar-b"></div>
                    <span class="opt-text" id="text-b">Cargando...</span>
                    <span class="opt-percent" id="perc-b">0%</span>
                </div>
            </div>
        </div>

    </div>

    <div class="footer-action">
        <a class="link-suggest" onclick="openModal()">¿Tienes una buena pregunta? Añádela al oráculo</a>
    </div>

    <div class="modal-overlay" id="suggestionModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3 style="color: var(--gold-glow); font-family:'Cinzel', serif; margin-bottom:15px;">Ofrenda al Oráculo</h3>
            <p style="opacity: 0.8; margin-bottom: 20px;">Envía tu tema para que sea juzgado.</p>
            <a href="mailto:tuemail@totalkmon.com?subject=Nueva Pregunta Totalkmon" class="btn-submit">Enviar Pregunta</a>
        </div>
    </div>

    <script>
        // --- CLAVES SUPABASE ---
        // ¡¡¡¡PEGA AQUÍ TUS CLAVES!!!!
        const SUPABASE_URL = https://zlddmiulbfjhwytfkvlw.supabase.co;
        const SUPABASE_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsZGRtaXVsYmZqaHd5dGZrdmx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0OTU4ODEsImV4cCI6MjA4MjA3MTg4MX0.61pMT7GbYU9ZpWJjZnsBGrF_Lb9jLX0OkIYf1a6k6GY;
        
        // Cliente
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ESTADO ---
        let currentClashId = null;
        let currentCategory = 'aleatorio';
        let allQuestions = []; // Caché local para filtrar rápido

        // --- FUNCIONES ---

        // 1. Cargar Preguntas (Con caché simple)
        async function fetchQuestions() {
            // Intentamos cargar de Supabase
            const { data, error } = await db.from('questions').select('*');
            
            if (data && data.length > 0) {
                allQuestions = data;
            } else {
                // Fallback por si la DB está vacía o falla
                allQuestions = [
                    {text: "¿Qué es lo que la gente malinterpreta más de ti?", category: "Profundo"},
                    {text: "¿Tu anécdota más vergonzosa?", category: "Fiesta"},
                    {text: "¿Vivir sin música o sin series?", category: "Cita"},
                    {text: "¿Plan de fin de semana ideal?", category: "Cita"}
                ];
            }
            nextQuestion(); // Mostrar la primera
        }

        function nextQuestion() {
            const card = document.querySelector('.card');
            card.style.transform = "scale(0.98)";
            card.style.opacity = "0.7";

            setTimeout(() => {
                // Filtrar
                let pool = allQuestions;
                if (currentCategory !== 'aleatorio') {
                    // Filtramos ignorando mayúsculas/minúsculas
                    pool = allQuestions.filter(q => q.category.toLowerCase() === currentCategory.toLowerCase());
                }
                
                // Si el filtro deja vacío, usamos todo
                if (pool.length === 0) pool = allQuestions;

                // Elegir Random
                const random = pool[Math.floor(Math.random() * pool.length)];
                
                document.getElementById('q-text').innerText = random.text;
                document.getElementById('q-cat').innerText = random.category;
                
                card.style.transform = "scale(1)";
                card.style.opacity = "1";
            }, 200);
        }

        // 2. Cambiar Categoría
        function setCategory(cat, event) {
            currentCategory = cat;
            // Actualizar botones visualmente
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            if(event) event.target.classList.add('active');
            
            // Lanzar pregunta nueva
            nextQuestion();
        }

        // 3. Dilema
        async function loadClash() {
            const { data } = await db.from('clashes').select('*').order('id', { ascending: false }).limit(1);
            if (data && data.length > 0) {
                const clash = data[0];
                currentClashId = clash.id;
                document.getElementById('text-a').innerText = clash.option_a;
                document.getElementById('text-b').innerText = clash.option_b;
                if(localStorage.getItem('voted_clash_' + clash.id)) showResults(clash.votes_a, clash.votes_b);
            }
        }

        async function vote(option) {
            if (!currentClashId || localStorage.getItem('voted_clash_' + currentClashId)) return;
            document.getElementById('clash-container').classList.add('voted');
            const { data: currentData } = await db.from('clashes').select('*').eq('id', currentClashId).single();
            let newA = currentData.votes_a; let newB = currentData.votes_b;
            if (option === 'a') newA++; else newB++;
            
            // Actualizar UI instantánea (Optimistic)
            showResults(newA, newB);

            // Guardar en DB
            await db.from('clashes').update({ votes_a: newA, votes_b: newB }).eq('id', currentClashId);
            localStorage.setItem('voted_clash_' + currentClashId, 'true');
        }

        function showResults(votesA, votesB) {
            document.getElementById('clash-container').classList.add('voted');
            const total = votesA + votesB;
            const perA = total === 0 ? 0 : Math.round((votesA / total) * 100);
            const perB = total === 0 ? 0 : Math.round((votesB / total) * 100);
            document.getElementById('bar-a').style.width = perA + '%';
            document.getElementById('bar-b').style.width = perB + '%';
            document.getElementById('perc-a').innerText = perA + '%';
            document.getElementById('perc-b').innerText = perB + '%';
        }

        // 4. UI General
        function switchTab(mode, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            if (mode === 'oracle') {
                document.getElementById('oracle-section').style.display = 'flex';
                document.getElementById('clash-section').style.display = 'none';
            } else {
                document.getElementById('oracle-section').style.display = 'none';
                document.getElementById('clash-section').style.display = 'block';
                loadClash();
            }
        }

        function openModal() {
            const modal = document.getElementById('suggestionModal');
            modal.style.display = 'flex';
            setTimeout(() => { modal.style.opacity = '1'; }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('suggestionModal');
            modal.style.opacity = '0';
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('suggestionModal');
            if (event.target == modal) closeModal();
        }

        // 5. Partículas (Visibles)
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 25; i++) {
                let p = document.createElement('div');
                p.classList.add('particle');
                p.style.left = Math.random() * 100 + '%';
                let size = Math.random() * 6 + 2;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                p.style.animationDelay = Math.random() * 5 + 's';
                p.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(p);
            }
        }

        // INIT
        createParticles();
        fetchQuestions(); // Carga inicial

    </script>
</body>
</html>