<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Totalkmon - El Juicio de Osiris</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-deep: #050a14;
            --bg-accent: #0b1e3b;
            --gold-glow: #ffbf00;
            --gold-muted: #c5a059;
            --text-main: #f0f0f0;
            --card-glass: rgba(20, 20, 30, 0.85);
            --red: #FF4757;
            --green: #2ED573;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif;
            background: radial-gradient(circle at top center, var(--bg-accent), var(--bg-deep));
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        /* PARTÍCULAS */
        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .particle { position: absolute; background: var(--gold-glow); border-radius: 50%; opacity: 0.4; box-shadow: 0 0 10px var(--gold-glow); animation: float 15s infinite linear; }
        @keyframes float { 0% { transform: translateY(110vh) translateX(0); opacity: 0; } 100% { transform: translateY(-10vh) translateX(20px); opacity: 0; } }

        /* HEADER */
        header { margin-top: 20px; text-align: center; margin-bottom: 15px; z-index: 10; }
        .logo-container { width: 60px; height: 60px; margin: 0 auto 10px; filter: drop-shadow(0 0 15px rgba(255, 191, 0, 0.3)); }
        h1 { font-family: 'Cinzel', serif; font-size: 2rem; letter-spacing: 2px; background: linear-gradient(to bottom, #fff, var(--gold-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* TABS */
        .tabs { display: flex; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 50px; margin-bottom: 20px; z-index: 10; border: 1px solid rgba(255,255,255,0.1); }
        .tab { padding: 10px 20px; border-radius: 40px; cursor: pointer; opacity: 0.6; transition: 0.3s; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .tab.active { background: var(--gold-glow); color: var(--bg-deep); opacity: 1; box-shadow: 0 0 15px rgba(255, 191, 0, 0.3); }

        /* ZONA PRINCIPAL */
        .main-stage { width: 100%; max-width: 500px; padding: 20px; flex-grow: 1; z-index: 10; position: relative; min-height: 500px; }
        
        /* TARJETA GENERICA */
        .card { 
            background: var(--card-glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 191, 0, 0.3); border-radius: 25px; padding: 40px 25px;
            text-align: center; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
            transition: all 0.4s ease; position: relative;
            min-height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* MODOS */
        #oracle-section, #clash-section, #judgment-section { display: none; animation: fadeIn 0.4s; width: 100%; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ESTILOS ORÁCULO */
        .category-pill { padding: 5px 15px; border-radius: 50px; border: 1px solid var(--gold-glow); color: var(--gold-glow); font-size: 0.7rem; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 1px; }
        .question-content { font-size: 1.5rem; line-height: 1.4; font-weight: 500; }
        .controls { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .btn-mode { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 10px; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; }
        .btn-mode.active { background: var(--gold-glow); color: black; border-color: var(--gold-glow); font-weight: bold; }

        /* ESTILOS JUICIO (NUEVO) */
        .judge-badge { background: var(--red); color: white; padding: 5px 15px; border-radius: 5px; font-family: 'Cinzel', serif; font-size: 0.8rem; margin-bottom: 20px; }
        .judge-controls { display: flex; gap: 20px; margin-top: 30px; width: 100%; justify-content: center; }
        .btn-judge { 
            width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-approve { background: rgba(46, 213, 115, 0.2); color: var(--green); border: 2px solid var(--green); }
        .btn-reject { background: rgba(255, 71, 87, 0.2); color: var(--red); border: 2px solid var(--red); }
        .btn-judge:hover { transform: scale(1.1); box-shadow: 0 0 15px currentColor; }
        
        /* ESTILOS DILEMA */
        .option-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin-bottom: 10px; position: relative; overflow: hidden; cursor: pointer; }
        .progress-bar { position: absolute; top: 0; left: 0; height: 100%; opacity: 0.2; width: 0%; transition: width 0.5s; }
        .opt-a .progress-bar { background: var(--red); } .opt-b .progress-bar { background: var(--green); }
        .opt-text { position: relative; z-index: 2; }
        .opt-percent { float: right; font-weight: bold; position: relative; z-index: 2; opacity: 0; }
        .voted .opt-percent { opacity: 1; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-accent); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--gold-muted); }
        input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; border-radius: 5px; }
        .btn-submit { background: var(--gold-glow); color: black; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; }

        .footer-action { margin-bottom: 20px; z-index: 10; }
        .link-suggest { color: var(--gold-muted); font-size: 0.8rem; text-decoration: none; border-bottom: 1px dotted var(--gold-muted); cursor: pointer; }
    </style>
</head>
<body>

    <div class="particles" id="particles"></div>

    <header>
        <div class="logo-container">
            <svg viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v19"/><path d="M5 8h14"/><path d="M5 8a3 3 0 0 1-3 3v4a3 3 0 0 0 6 0v-4a3 3 0 0 1-3-3z"/><path d="M19 8a3 3 0 0 1-3 3v4a3 3 0 0 0 6 0v-4a3 3 0 0 1-3-3z"/></svg>
        </div>
        <h1>Totalkmon</h1>
        <p style="font-size: 0.7rem; letter-spacing: 2px; color: #aaa; text-transform: uppercase;">El Juicio de Osiris</p>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('oracle', this)">Oráculo</div>
        <div class="tab" onclick="switchTab('judgment', this)">Juicio ⚖️</div>
        <div class="tab" onclick="switchTab('clash', this)">Dilema</div>
    </div>

    <div class="main-stage">
        
        <div id="oracle-section" style="display: block;">
            <div class="card" onclick="nextQuestion()">
                <span class="category-pill" id="q-cat">Bienvenida</span>
                <p class="question-content" id="q-text">Invocando temas...</p>
                <p style="margin-top:20px; font-size:0.7rem; opacity:0.5;">(Toca para siguiente)</p>
            </div>
            <div class="controls">
                <button class="btn-mode active" onclick="setCategory('aleatorio', event)">Mix</button>
                <button class="btn-mode" onclick="setCategory('Cita', event)">Cita</button>
                <button class="btn-mode" onclick="setCategory('Fiesta', event)">Fiesta</button>
                <button class="btn-mode" onclick="setCategory('Profundo', event)">Profundo</button>
            </div>
        </div>

        <div id="judgment-section">
            <div class="card">
                <div class="judge-badge">Purgatorio</div>
                <p class="question-content" id="judge-text">Buscando almas perdidas...</p>
                <span id="judge-cat" style="font-size: 0.8rem; color: var(--gold-muted); margin-top: 10px;">...</span>
                
                <div class="judge-controls">
                    <button class="btn-judge btn-reject" onclick="voteJudgment(-1)"><i class="fas fa-times"></i></button>
                    <button class="btn-judge btn-approve" onclick="voteJudgment(1)"><i class="fas fa-check"></i></button>
                </div>
                <p style="font-size: 0.7rem; margin-top: 20px; opacity: 0.6;">Si apruebas, subirá al Oráculo.</p>
            </div>
        </div>

        <div id="clash-section">
            <h3 style="text-align: center; color: var(--gold-glow); font-family:'Cinzel',serif; margin-bottom:20px;">Estadísticas Mundiales</h3>
            <div id="clash-container">
                <div class="option-btn opt-a" onclick="voteClash('a')">
                    <div class="progress-bar" id="bar-a"></div>
                    <span class="opt-text" id="text-a">Cargando...</span>
                    <span class="opt-percent" id="perc-a">0%</span>
                </div>
                <div class="option-btn opt-b" onclick="voteClash('b')">
                    <div class="progress-bar" id="bar-b"></div>
                    <span class="opt-text" id="text-b">Cargando...</span>
                    <span class="opt-percent" id="perc-b">0%</span>
                </div>
            </div>
        </div>

    </div>

    <div class="footer-action">
        <a class="link-suggest" onclick="openModal()">+ Enviar Ofrenda al Purgatorio</a>
    </div>

    <div class="modal-overlay" id="suggestionModal">
        <div class="modal-content">
            <span style="position:absolute; top:10px; right:20px; font-size:1.5rem; cursor:pointer;" onclick="closeModal()">&times;</span>
            <h3 style="color:var(--gold-glow); font-family:'Cinzel', serif; margin-bottom:20px;">Crear Pregunta</h3>
            <select id="sug-cat">
                <option value="Aleatorio">General</option>
                <option value="Cita">Cita</option>
                <option value="Fiesta">Fiesta</option>
                <option value="Profundo">Profundo</option>
            </select>
            <textarea id="sug-text" rows="4" placeholder="Escribe tu pregunta..."></textarea>
            <button class="btn-submit" onclick="sendSuggestion()">Enviar al Juicio</button>
        </div>
    </div>

    <script>
        // --- PEGA TUS CLAVES AQUÍ ---
        const SUPABASE_URL = 'https://zlddmiulbfjhwytfkvlw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsZGRtaXVsYmZqaHd5dGZrdmx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0OTU4ODEsImV4cCI6MjA4MjA3MTg4MX0.61pMT7GbYU9ZpWJjZnsBGrF_Lb9jLX0OkIYf1a6k6GY';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ESTADO
        let allQuestions = [];
        let currentCategory = 'aleatorio';
        let currentJudgeId = null;
        let currentClashId = null;

        // --- 1. ORÁCULO ---
        async function fetchQuestions() {
            // Cargar preguntas OFICIALES
            const { data } = await db.from('questions').select('*');
            if(data) allQuestions = data;
            nextQuestion();
        }

        function nextQuestion() {
            let pool = allQuestions;
            if(currentCategory !== 'aleatorio') pool = allQuestions.filter(q => q.category.toLowerCase() === currentCategory.toLowerCase());
            if(pool.length === 0) pool = allQuestions.length > 0 ? allQuestions : [{text:"Base de datos vacía", category:"Error"}];
            
            const random = pool[Math.floor(Math.random() * pool.length)];
            document.getElementById('q-text').innerText = random.text;
            document.getElementById('q-cat').innerText = random.category;
        }

        function setCategory(cat, e) {
            currentCategory = cat;
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            if(e) e.target.classList.add('active');
            nextQuestion();
        }

        // --- 2. EL JUICIO DE OSIRIS (MODERACIÓN) ---
        async function fetchJudge() {
            // Cargar UNA sugerencia aleatoria
            const { data } = await db.from('suggestions').select('*').limit(10); // Traemos 10 para variar
            
            if (data && data.length > 0) {
                const random = data[Math.floor(Math.random() * data.length)];
                currentJudgeId = random.id;
                document.getElementById('judge-text').innerText = random.text;
                document.getElementById('judge-cat').innerText = "Categoría propuesta: " + random.category;
            } else {
                document.getElementById('judge-text').innerText = "El Purgatorio está vacío.";
                document.getElementById('judge-cat').innerText = "¡Vuelve más tarde!";
                currentJudgeId = null;
            }
        }

        async function voteJudgment(value) {
            if(!currentJudgeId) return;

            // Optimistic UI (Cambio visual inmediato)
            document.getElementById('judge-text').innerText = "Juzgando...";
            
            // 1. Obtener datos actuales
            const { data: current } = await db.from('suggestions').select('*').eq('id', currentJudgeId).single();
            if(!current) { fetchJudge(); return; }

            let newVotes = (current.votes || 0) + value;

            // 2. LÓGICA DE ASCENSIÓN (Si llega a 5 votos, se promueve)
            if (newVotes >= 3) { // Ponemos 3 para que sea fácil probar ahora
                // Insertar en preguntas oficiales
                await db.from('questions').insert([{ text: current.text, category: current.category }]);
                // Borrar de sugerencias
                await db.from('suggestions').delete().eq('id', currentJudgeId);
                alert("¡ASCENSIÓN! Esta pregunta ha sido aprobada por los dioses (la comunidad).");
            } else if (newVotes <= -3) {
                // Borrar si es muy odiada
                await db.from('suggestions').delete().eq('id', currentJudgeId);
            } else {
                // Solo actualizar votos
                await db.from('suggestions').update({ votes: newVotes }).eq('id', currentJudgeId);
            }

            // Cargar siguiente
            setTimeout(fetchJudge, 500);
        }

        // --- 3. DILEMA ---
        async function loadClash() {
            const { data } = await db.from('clashes').select('*').order('id', { ascending: false }).limit(1);
            if(data && data.length > 0) {
                const c = data[0];
                currentClashId = c.id;
                document.getElementById('text-a').innerText = c.option_a;
                document.getElementById('text-b').innerText = c.option_b;
                if(localStorage.getItem('voted_'+c.id)) showResults(c.votes_a, c.votes_b);
            }
        }
        async function voteClash(opt) {
            if(!currentClashId || localStorage.getItem('voted_'+currentClashId)) return;
            document.getElementById('clash-container').classList.add('voted');
            const { data } = await db.from('clashes').select('*').eq('id', currentClashId).single();
            let a = data.votes_a, b = data.votes_b;
            if(opt === 'a') a++; else b++;
            showResults(a, b);
            await db.from('clashes').update({ votes_a: a, votes_b: b }).eq('id', currentClashId);
            localStorage.setItem('voted_'+currentClashId, 'true');
        }
        function showResults(a, b) {
            document.getElementById('clash-container').classList.add('voted');
            let t = a + b;
            let pa = t===0?0:Math.round((a/t)*100), pb = t===0?0:Math.round((b/t)*100);
            document.getElementById('bar-a').style.width = pa+'%';
            document.getElementById('bar-b').style.width = pb+'%';
            document.getElementById('perc-a').innerText = pa+'%';
            document.getElementById('perc-b').innerText = pb+'%';
        }

        // --- COMUNIDAD ---
        async function sendSuggestion() {
            const txt = document.getElementById('sug-text').value;
            const cat = document.getElementById('sug-cat').value;
            if(!txt) return;
            await db.from('suggestions').insert([{ text: txt, category: cat, votes: 0 }]);
            alert("Tu ofrenda está en el Purgatorio esperando juicio.");
            closeModal();
            document.getElementById('sug-text').value = "";
        }

        // UI
        function switchTab(t, el) {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('oracle-section').style.display = 'none';
            document.getElementById('judgment-section').style.display = 'none';
            document.getElementById('clash-section').style.display = 'none';
            
            if(t==='oracle') document.getElementById('oracle-section').style.display = 'block';
            if(t==='judgment') { document.getElementById('judgment-section').style.display = 'block'; fetchJudge(); }
            if(t==='clash') { document.getElementById('clash-section').style.display = 'block'; loadClash(); }
        }
        function openModal() { document.getElementById('suggestionModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('suggestionModal').style.display = 'none'; }
        
        // PARTICULAS
        const pc = document.getElementById('particles');
        for(let i=0;i<20;i++){
            let p=document.createElement('div'); p.className='particle';
            p.style.left=Math.random()*100+'%'; p.style.width=p.style.height=(Math.random()*6+2)+'px';
            p.style.animationDelay=Math.random()*5+'s'; p.style.animationDuration=(Math.random()*10+10)+'s';
            pc.appendChild(p);
        }

        // INIT
        fetchQuestions();
    </script>
</body>
</html>